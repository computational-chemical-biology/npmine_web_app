{% extends "layout.html" %}

{% block bannercontent %}

{% include 'components/navbar.html' %}
{% include 'components/main-banner.html' %}

{% block tablecontent %}
<div class="container mt-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 p-3 bg-light rounded shadow-sm">
    
    <div class="flex-grow-1 me-3 mb-2 mb-md-0" style="max-width: 300px;">
      <input 
        type="text" 
        id="search-input" 
        class="form-control form-control-sm shadow-sm" 
        placeholder="ðŸ” Search compounds..."
      >
    </div>

    <div class="form-check form-switch mb-2 mb-md-0">
      <input class="form-check-input" type="checkbox" id="show-deleted-toggle">
      <label class="form-check-label fw-medium" for="show-deleted-toggle">
        Show Deleted Compounds
      </label>
    </div>

    <div class="d-flex align-items-center gap-2 mb-2 mb-md-0">
      <label for="glycoside-filter" class="form-label mb-0 fw-semibold">
        Is Glycoside:
      </label>
      <select 
        id="glycoside-filter" 
        class="form-select form-select-sm w-auto shadow-sm border-secondary"
      >
        <option value="all">All</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>
    </div>

  </div>

  <hr>

  <div id="table"></div>
</div>



<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
<script>
  const updateUrl = (prev, query) => {
    return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
  };

  const editButtonFormatter = (cell, row) => {
    const compoundId = cell;
    
    const compoundOwnerId = row.user_id;

    const canEdit = isAdmin || isEditor || (current_user_id === compoundOwnerId);

    if (canEdit) {
      return gridjs.html(`<div style="width: 50px;"><a href="/compound/${compoundId}/edit">Edit</a></div>`);
    }

    return null; 
  };

  const deleteButtonFormatter = (cell, row) => {
    return gridjs.html(`
      <form method="POST" action="/compound/${cell}/delete" onsubmit="return confirm('Are you sure you want to delete this compound?')">
        <input type="hidden" name="_method" value="POST">
        <button type="submit">Delete</button>
      </form>
    `);
  };

  const logged_in = {{ logged_in|default(false)|lower }};

  const columns = [
    {
      id: 'id',
      name: 'ID',
      sort: false,
      width: 75,
      resizeable: true,
      formatter: (cell, row) => {
        return gridjs.html('<a href="/compound/' + cell + '">' + cell + '</a>');
      }
    },
    {
    id: 'compound_name',
    name: 'Compound Name',
    sort: false,
    formatter: (cell, row) => {
      if (cell) {
        return gridjs.html('<a href="/compound/' + row.cells[0].data + '">' + cell + '</a>');
      } else {
        return '-'; 
      }
    }
  },
  {
  id: 'compound_image',
  name: 'Compound Image',
  sort: false,
  formatter: (cell, row) => {
    if (cell) {
      return gridjs.html(`<img src="${cell}" alt="Structure" style="max-width: 100px; max-height: 100px;">`);
    } else {
      return ''; 
    }
  }
},
    { 
      id: 'inchikey', name: 'InChI Key', 
      sort: false, width: 200, resizeable: true, 
    },
    {
      id: 'pubchem',
      name: 'PubChem ID',
      sort: false,
      formatter: (cell, row) => {
        if(cell)
          return gridjs.html('<a href="https://pubchem.ncbi.nlm.nih.gov/compound/' + cell + '">' + cell + '</a>');
        return 'unknown';
      }
    },
  ];

const current_user_id = {{ current_user.id|default(0) }};

const role_id = {{ current_user.role_id|default(0) }};  

const isAdmin = role_id === 1;
const isEditor = role_id === 2; 

if (isEditor || isAdmin) {
  columns.push({ id: 'id', name: 'Edit', sort: false, width: 100, resizable: true, formatter: editButtonFormatter });
}

if (isAdmin) {
  columns.push({ id: 'id', name: 'Delete', sort: false, resizable: true, formatter: deleteButtonFormatter });
}

  const grid = new gridjs.Grid({
    columns: columns,
    server: {
      url: '/api/data',
      then: data => data.data,
      total: data => data.total,
    },
    sort: {
      enabled: true,
      multiColumn: true,
      server: {
        url: (prev, columns) => {
          const columnIds = ['id','inchikey', 'pubchem'];
          const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
          return updateUrl(prev, {sort});
        },
      },
    },
    pagination: {
      enabled: true,
      server: {
        url: (prev, page, limit) => {
          return updateUrl(prev, {start: page * limit, length: limit});
        },
      },
    },
    resizable: true,
    sort: true
});

const searchInput = document.getElementById('search-input');
const showDeletedToggle = document.getElementById('show-deleted-toggle');
const glycosideFilterInput = document.getElementById('glycoside-filter'); 

function debounce(func, delay) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), delay);
  };
}

function updateAndRender() {
  const baseUrl = '/api/data';
  const params = new URLSearchParams();

  const searchTerm = searchInput.value.trim();
  const showDeleted = showDeletedToggle.checked;
  const glycosideFilter = glycosideFilterInput.value.trim();
  
  if (searchTerm) {
    params.set('search', searchTerm);
  }
  if (showDeleted) {
    params.set('show_deleted', 'true');
  }
  if (glycosideFilter !== 'all') {
    params.set('is_glycoside', glycosideFilter);
  }

  const newUrl = `${baseUrl}?${params.toString()}`;

  grid.updateConfig({
    server: {
      ...grid.config.server,
      url: newUrl            
    }
  }).forceRender();
}

searchInput.addEventListener('input', (updateAndRender)); 
showDeletedToggle.addEventListener('change', (updateAndRender)); 
glycosideFilterInput.addEventListener('change', updateAndRender);

grid.render(document.getElementById('table'));
</script>

{% endblock tablecontent %}

{% include 'components/footer.html' %}

{% endblock bannercontent %}





